<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Simple Radio">
    <title>Accessible Radio</title>

    <style>
        /* High contrast, large text reset */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            color: #FFFFFF;
            font-family: -apple-system, Helvetica, Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        /* Horizontal sliding container */
        #app-container {
            width: 400vw; /* 4 categories */
            height: 100vh;
            display: flex;
            display: -webkit-flex;
            -webkit-transition: -webkit-transform 0.4s ease-out;
            transition: transform 0.4s ease-out;
        }

        /* Vertical sliding columns (Categories) */
        .category-column {
            width: 100vw;
            display: flex;
            display: -webkit-flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-transition: -webkit-transform 0.4s ease-out;
            transition: transform 0.4s ease-out;
        }

        /* Individual Station Scenes */
        .panel {
            width: 100vw;
            height: 100vh;
            flex: 0 0 100vh; /* Force panel to be exactly screen height */
            -webkit-flex: 0 0 100vh;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-align-items: center;
            align-items: center;
            box-sizing: border-box;
            padding: 5vw;
            text-align: center;
            cursor: pointer;
        }

        /* Typography */
        .category-title {
            font-size: 5vmin;
            text-transform: uppercase;
            letter-spacing: 0.5vmin;
            margin-bottom: 2vmin;
            font-weight: bold;
        }

        h1 {
            font-size: 10vmin;
            margin: 0 0 20px 0;
            color: #FFFFFF;
        }

        .status {
            font-size: 5.5vmin;
            color: #AAAAAA;
            margin-bottom: 30px;
            min-height: 8vmin;
        }

        .swipe-hint {
            font-size: 4vmin;
            color: #666666;
            margin-top: 6vmin;
        }

        /* The massive play button */
        .icon-btn {
            width: 40vmin;
            height: 40vmin;
            background-color: #222222;
            border-radius: 50%;
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-align-items: center;
            align-items: center;
            font-size: 18vmin;
            border: 1.5vmin solid #555555;
            -webkit-transition: all 0.2s ease;
            transition: all 0.2s ease;
        }

        /* Category Color Theming */
        .cat-0 .icon-btn { border-color: #FFD700; } /* Music: Yellow */
        .cat-0 .category-title { color: #FFD700; }

        .cat-1 .icon-btn { border-color: #00FFFF; } /* News: Cyan */
        .cat-1 .category-title { color: #00FFFF; }

        .cat-2 .icon-btn { border-color: #FF00FF; } /* Science: Magenta */
        .cat-2 .category-title { color: #FF00FF; }

        .cat-3 .icon-btn { border-color: #FFA500; } /* Tech: Orange */
        .cat-3 .category-title { color: #FFA500; }

        /* Playing Animation State */
        .playing .icon-btn {
            background-color: #004400 !important;
            border-color: #00FF00 !important;
            box-shadow: 0 0 4vmin #00FF00;
        }

        /* Pagination Layout */
        #h-pagination {
            position: absolute;
            bottom: 3vh;
            width: 100%;
            text-align: center;
            pointer-events: none;
        }

        #v-pagination {
            position: absolute;
            right: 3vw;
            top: 0;
            height: 100%;
            display: flex;
            display: -webkit-flex;
            -webkit-flex-direction: column;
            flex-direction: column;
            -webkit-justify-content: center;
            justify-content: center;
            pointer-events: none;
        }

        .dot {
            background-color: #444;
            border-radius: 50%;
        }

        .h-dot {
            display: inline-block;
            width: 3.5vmin;
            height: 3.5vmin;
            margin: 0 1.5vmin;
        }

        .v-dot {
            width: 2.5vmin;
            height: 2.5vmin;
            margin: 1.5vmin 0;
        }

        .dot.active {
            background-color: #FFFFFF;
            box-shadow: 0 0 1vmin #FFFFFF;
        }

        #log-toggle {
            position: absolute;
            top: 2vh;
            left: 2vw;
            z-index: 10;
            font-size: 4vmin;
            background: #111;
            color: #fff;
            border: 0.6vmin solid #888;
            border-radius: 1vmin;
            padding: 1vmin 2vmin;
        }

        #log-panel {
            position: absolute;
            top: 10vh;
            left: 5vw;
            width: 90vw;
            height: 45vh;
            z-index: 11;
            border: 0.6vmin solid #888;
            background: rgba(0, 0, 0, 0.95);
            padding: 2vmin;
            box-sizing: border-box;
            display: none;
        }

        #log-panel.visible {
            display: block;
        }

        #log-output {
            width: 100%;
            height: 100%;
            background: #000;
            color: #0f0;
            border: 0;
            font-size: 2.9vmin;
            font-family: monospace;
            resize: none;
        }
    </style>
</head>
<body>

    <!-- Dynamic Container -->
    <div id="app-container"></div>

    <!-- Pagination Indicators -->
    <div id="h-pagination"></div>
    <div id="v-pagination"></div>
    <button id="log-toggle" type="button" onclick="toggleLogPanel()">Logs</button>
    <div id="log-panel">
        <textarea id="log-output" readonly></textarea>
    </div>

    <!-- Single Persistent Audio Engine -->
    <audio id="radio-player" preload="none" playsinline webkit-playsinline></audio>

    <script>
        // STRICT ES5 COMPATIBILITY FOR iOS 9

        // --- DATA STRUCTURE (4 Categories x 5 Stations) ---
        var categories = [
            {
                name: "Music",
                icon: "ðŸŽµ",
                stations: [
                    { name: "Groove Salad", sources: ["https://ice1.somafm.com/groovesalad-128-mp3", "https://ice1.somafm.com/groovesalad-64-aac"] },
                    {
                        name: "Radio Paradise",
                        sources: [
                            "https://stream.radioparadise.com/mp3-192",
                            "https://stream.radioparadise.com/mp3-128",
                            "https://stream.radioparadise.com/aac-320"
                        ]
                    },
                    { name: "Code Radio", url: "https://coderadio-admin.freecodecamp.org/radio/8000/radio.mp3" },
                    { name: "Secret Agent", sources: ["https://ice1.somafm.com/secretagent-128-mp3", "https://ice1.somafm.com/secretagent-64-aac"] },
                    { name: "PopTron", sources: ["https://ice1.somafm.com/poptron-128-mp3", "https://ice1.somafm.com/poptron-64-aac"] }
                ]
            },
            {
                name: "News",
                icon: "ðŸ“°",
                stations: [
                    { name: "NPR 24/7", url: "https://npr-ice.streamguys1.com/npr-cmp3" },
                    { name: "WNYC New York", url: "https://fm939.wnyc.org/wnycfm" },
                    { name: "MPR News", url: "https://mprstreams.mpr.org/newsim-128" },
                    { name: "KQED San Fran", url: "https://streams.kqed.org/kqedradio" },
                    { name: "WAMU Washington", url: "https://wamu-1.streamguys.com/wamu-1" }
                ]
            },
            {
                name: "Science",
                icon: "ðŸš€",
                stations: [
                    { name: "Mission Control", sources: ["https://ice1.somafm.com/missioncontrol-128-mp3", "https://ice1.somafm.com/missioncontrol-64-aac"] },
                    { name: "NASA Third Rock", url: "https://rfcmedia.streamguys1.com/thirdrock.mp3" },
                    { name: "Deep Space One", sources: ["https://ice1.somafm.com/deepspaceone-128-mp3", "https://ice1.somafm.com/deepspaceone-64-aac"] },
                    { name: "Space Station", sources: ["https://ice1.somafm.com/spacestation-128-mp3", "https://ice1.somafm.com/spacestation-64-aac"] },
                    { name: "Sci-Fi Radio", url: "https://broadcaster.scifi.radio/listen.mp3" }
                ]
            },
            {
                name: "Tech & Culture",
                icon: "ðŸ’»",
                stations: [
                    { name: "DEF CON Radio", sources: ["https://ice1.somafm.com/defcon-128-mp3", "https://ice1.somafm.com/defcon-64-aac"] },
                    { name: "KCRW Radio", url: "https://kcrw.streamguys1.com/kcrw_192k_mp3_on_air" },
                    { name: "SomaFM Fluid", sources: ["https://ice1.somafm.com/fluid-128-mp3", "https://ice1.somafm.com/fluid-64-aac"] },
                    { name: "Drone Zone", sources: ["https://ice1.somafm.com/dronezone-128-mp3", "https://ice1.somafm.com/dronezone-64-aac"] },
                    { name: "Synphaera", sources: ["https://ice1.somafm.com/synphaera-128-mp3", "https://ice1.somafm.com/synphaera-64-aac"] }
                ]
            }
        ];

        // --- INITIALIZE DOM ---
        var container = document.getElementById('app-container');
        var player = document.getElementById('radio-player');

        // Build the Panels
        var html = '';
        for (var c = 0; c < categories.length; c++) {
            html += '<div class="category-column" id="col-' + c + '">';
            for (var s = 0; s < categories[c].stations.length; s++) {
                var st = categories[c].stations[s];
                html += '<div class="panel cat-' + c + '" id="panel-' + c + '-' + s + '" onclick="handleStationTap(' + c + ', ' + s + ')">';
                html += '<div class="category-title">' + categories[c].name + '</div>';
                html += '<h1>' + st.name + '</h1>';
                html += '<div class="status" id="status-' + c + '-' + s + '">Tap to Play</div>';
                html += '<div class="icon-btn">' + categories[c].icon + '</div>';
                html += '<div class="swipe-hint">â†• Swipe for more channels</div>';
                html += '</div>';
            }
            html += '</div>';
        }
        container.innerHTML = html;

        // Build Horizontal Pagination (Categories)
        var hDots = '';
        for (var i = 0; i < categories.length; i++) {
            hDots += '<span class="dot h-dot" id="h-dot-' + i + '"></span>';
        }
        document.getElementById('h-pagination').innerHTML = hDots;

        // Build Vertical Pagination (Stations)
        var vDots = '';
        for (var i = 0; i < 5; i++) {
            vDots += '<span class="dot v-dot" id="v-dot-' + i + '"></span>';
        }
        document.getElementById('v-pagination').innerHTML = vDots;


        // --- STATE MANAGEMENT ---
        var currentCat = 0;
        var currentStationInCat = [0, 0, 0, 0]; // Tracks vertical position of each column

        var playingCat = -1;
        var playingStation = -1;
        var isFallback = false;
        var currentSourceList = [];
        var currentSourceIndex = 0;
        var retryTimer = 0;
        var sourceAttemptCount = 0;
        var STARTUP_TIMEOUT_MS = 15000;
        var BUFFER_TIMEOUT_MS = 12000;
        var MAX_ATTEMPTS_PER_SOURCE = 2;
        var logs = [];

        function detectStreamFormat(url) {
            var lower = (url || '').toLowerCase();

            if (lower.indexOf('.aac') >= 0 || lower.indexOf('-aac') >= 0 || lower.indexOf('/aac') >= 0 || lower.indexOf('aac-') >= 0) {
                return 'aac';
            }

            if (lower.indexOf('.m3u8') >= 0) {
                return 'hls';
            }

            if (lower.indexOf('.ogg') >= 0 || lower.indexOf('ogg') >= 0) {
                return 'ogg';
            }

            if (lower.indexOf('.mp3') >= 0 || lower.indexOf('-mp3') >= 0 || lower.indexOf('/mp3') >= 0 || lower.indexOf('mp3-') >= 0) {
                return 'mp3';
            }

            return 'unknown';
        }

        function getMimeForFormat(format) {
            if (format === 'mp3') return 'audio/mpeg';
            if (format === 'aac') return 'audio/aac';
            if (format === 'ogg') return 'audio/ogg';
            if (format === 'hls') return 'application/vnd.apple.mpegurl';
            return '';
        }

        function logCurrentSourceDiagnostics(label, sourceUrl) {
            var format = detectStreamFormat(sourceUrl);
            var mime = getMimeForFormat(format);
            var canPlay = mime ? player.canPlayType(mime) : 'unknown';
            var networkStateMap = ['NETWORK_EMPTY', 'NETWORK_IDLE', 'NETWORK_LOADING', 'NETWORK_NO_SOURCE'];
            var readyStateMap = ['HAVE_NOTHING', 'HAVE_METADATA', 'HAVE_CURRENT_DATA', 'HAVE_FUTURE_DATA', 'HAVE_ENOUGH_DATA'];
            var networkState = networkStateMap[player.networkState] || ('UNKNOWN(' + player.networkState + ')');
            var readyState = readyStateMap[player.readyState] || ('UNKNOWN(' + player.readyState + ')');

            pushLog(label + ' source=' + sourceUrl + ' format=' + format + ' mime=' + (mime || 'n/a') + ' canPlayType=' + canPlay + ' network=' + networkState + ' ready=' + readyState);
        }

        // --- SWIPE LOGIC ---
        var startX = 0, startY = 0;
        var endX = 0, endY = 0;
        var suppressTapUntil = 0;

        document.addEventListener('touchstart', function(e) {
            startX = e.changedTouches[0].screenX;
            startY = e.changedTouches[0].screenY;
        }, false);

        document.addEventListener('touchend', function(e) {
            endX = e.changedTouches[0].screenX;
            endY = e.changedTouches[0].screenY;

            var dx = endX - startX;
            var dy = endY - startY;
            var swipeThreshold = 50;

            // Only act if the touch moved further than the threshold
            if (Math.abs(dx) > swipeThreshold || Math.abs(dy) > swipeThreshold) {
                suppressTapUntil = new Date().getTime() + 400;
                // Determine if swipe was mostly horizontal or vertical
                if (Math.abs(dx) > Math.abs(dy)) {
                    // Horizontal Swipe (Category)
                    if (dx > swipeThreshold && currentCat > 0) {
                        currentCat--;
                    } else if (dx < -swipeThreshold && currentCat < categories.length - 1) {
                        currentCat++;
                    }
                } else {
                    // Vertical Swipe (Station)
                    // Note: Swiping UP (negative dy) moves DOWN the list.
                    var maxStations = categories[currentCat].stations.length - 1;
                    if (dy > swipeThreshold && currentStationInCat[currentCat] > 0) {
                        currentStationInCat[currentCat]--;
                    } else if (dy < -swipeThreshold && currentStationInCat[currentCat] < maxStations) {
                        currentStationInCat[currentCat]++;
                    }
                }
                updateView();
            }
        }, false);

        function updateView() {
            // Move horizontally
            var tx = -(currentCat * 100);
            container.style.transform = 'translateX(' + tx + 'vw)';
            container.style.webkitTransform = 'translateX(' + tx + 'vw)';

            // Move the current column vertically
            var col = document.getElementById('col-' + currentCat);
            var ty = -(currentStationInCat[currentCat] * 100);
            col.style.transform = 'translateY(' + ty + 'vh)';
            col.style.webkitTransform = 'translateY(' + ty + 'vh)';

            // Update Horizontal Dots
            for (var i = 0; i < categories.length; i++) {
                var hDot = document.getElementById('h-dot-' + i);
                hDot.className = (i === currentCat) ? 'dot h-dot active' : 'dot h-dot';
            }

            // Update Vertical Dots
            for (var i = 0; i < 5; i++) {
                var vDot = document.getElementById('v-dot-' + i);
                vDot.className = (i === currentStationInCat[currentCat]) ? 'dot v-dot active' : 'dot v-dot';
            }
        }

        // --- AUDIO ENGINE EVENT HANDLERS ---
        player.addEventListener('waiting', function() {
            if (playingCat >= 0 && playingStation >= 0) {
                document.getElementById('status-' + playingCat + '-' + playingStation).innerText = "Buffering...";
            }
            pushLog('Audio waiting event');
            armRetryTimer('Buffering timeout, trying next source', BUFFER_TIMEOUT_MS);
        });

        player.addEventListener('playing', function() {
            if (!isFallback) {
                updateUI(playingCat, playingStation, true);
            }
            pushLog('Audio playing: ' + player.currentSrc);
            logCurrentSourceDiagnostics('Playing diagnostics', player.currentSrc);
            clearRetryTimer();
        });

        player.addEventListener('play', function() {
            pushLog('Audio play event: ' + player.currentSrc);
        });

        player.addEventListener('stalled', function() {
            pushLog('Audio stalled: ' + player.currentSrc);
            armRetryTimer('Stall persisted, trying next source', BUFFER_TIMEOUT_MS);
        });

        player.addEventListener('canplay', function() {
            pushLog('Audio canplay: ' + player.currentSrc);
            armRetryTimer('Playback did not begin after canplay, trying next source', BUFFER_TIMEOUT_MS);
        });

        player.addEventListener('error', function(e) {
            pushLog('Audio error code=' + (player.error ? player.error.code : 'unknown'));
            logCurrentSourceDiagnostics('Error diagnostics', player.currentSrc || currentSourceList[currentSourceIndex]);
            if (isFallback) return;
            tryNextSource();
        });

        // --- AUDIO LOGIC ---
        function safePlay(cIndex, sIndex) {
            var playPromise = player.play();

            if (playPromise !== undefined) {
                playPromise.catch(function(error) {
                    if (error.name === "AbortError") return;

                    pushLog('Play() rejected: ' + error.name);

                    if (error.name === "NotAllowedError") {
                        clearRetryTimer();
                        document.getElementById('status-' + cIndex + '-' + sIndex).innerText = "Tap again to start audio";
                        return;
                    }

                    tryNextSource();
                });
            }

            armRetryTimer('No playback after startup timeout, trying next source', STARTUP_TIMEOUT_MS);
        }

        function handleStationTap(cIndex, sIndex) {
            if (new Date().getTime() < suppressTapUntil) return;

            // If tapping the exact station that is currently playing
            if (playingCat === cIndex && playingStation === sIndex && !player.paused) {
                player.pause();
                updateUI(cIndex, sIndex, false);
            } else {
                player.pause();
                isFallback = false;
                clearRetryTimer();

                currentSourceList = getStationSources(cIndex, sIndex);
                currentSourceIndex = 0;
                sourceAttemptCount = 0;
                pushLog('Selected ' + categories[cIndex].stations[sIndex].name + ' with ' + currentSourceList.length + ' source(s)');
                pushLog('Source order: ' + currentSourceList.join(' | '));

                player.src = currentSourceList[currentSourceIndex];
                logCurrentSourceDiagnostics('Trying initial', currentSourceList[currentSourceIndex]);
                player.load();
                playingCat = cIndex;
                playingStation = sIndex;

                updateUI(cIndex, sIndex, true);
                safePlay(cIndex, sIndex);
            }
        }

        function getStationSources(cIndex, sIndex) {
            var station = categories[cIndex].stations[sIndex];
            if (station.sources && station.sources.length) {
                return station.sources;
            }
            return [station.url];
        }

        function tryNextSource() {
            if (playingCat < 0 || playingStation < 0) {
                return;
            }

            if (sourceAttemptCount < MAX_ATTEMPTS_PER_SOURCE - 1) {
                sourceAttemptCount++;
                pushLog('Retrying source ' + (currentSourceIndex + 1) + '/' + currentSourceList.length + ' (attempt ' + (sourceAttemptCount + 1) + ')');
                player.pause();
                player.src = currentSourceList[currentSourceIndex];
                logCurrentSourceDiagnostics('Retry attempt', currentSourceList[currentSourceIndex]);
                player.load();
                safePlay(playingCat, playingStation);
                return;
            }

            if (currentSourceIndex < currentSourceList.length - 1) {
                currentSourceIndex++;
                sourceAttemptCount = 0;
                var nextSource = currentSourceList[currentSourceIndex];
                document.getElementById('status-' + playingCat + '-' + playingStation).innerText = 'Trying alternate stream...';
                pushLog('Trying source ' + (currentSourceIndex + 1) + '/' + currentSourceList.length + ': ' + nextSource);
                player.pause();
                player.src = nextSource;
                logCurrentSourceDiagnostics('Trying alternate', nextSource);
                player.load();
                safePlay(playingCat, playingStation);
                return;
            }

            clearRetryTimer();
            updateUI(playingCat, playingStation, false);
            document.getElementById('status-' + playingCat + '-' + playingStation).innerText = 'Stream Error on this device';
            pushLog('All sources failed for current station');
        }

        function armRetryTimer(message, delayMs) {
            clearRetryTimer();
            retryTimer = setTimeout(function() {
                pushLog(message);
                tryNextSource();
            }, delayMs);
        }

        function clearRetryTimer() {
            if (retryTimer) {
                clearTimeout(retryTimer);
                retryTimer = 0;
            }
        }

        function pushLog(message) {
            var now = new Date();
            var hh = ('0' + now.getHours()).slice(-2);
            var mm = ('0' + now.getMinutes()).slice(-2);
            var ss = ('0' + now.getSeconds()).slice(-2);
            var line = hh + ':' + mm + ':' + ss + ' ' + message;
            logs.push(line);
            if (logs.length > 120) {
                logs.shift();
            }
            document.getElementById('log-output').value = logs.join('\n');
        }

        function toggleLogPanel() {
            var panel = document.getElementById('log-panel');
            if (panel.className.indexOf('visible') >= 0) {
                panel.className = '';
            } else {
                panel.className = 'visible';
            }
        }

        function updateUI(activeC, activeS, isPlaying) {
            // Reset ALL statuses back to default
            for (var c = 0; c < categories.length; c++) {
                for (var s = 0; s < categories[c].stations.length; s++) {
                    var p = document.getElementById('panel-' + c + '-' + s);
                    var stat = document.getElementById('status-' + c + '-' + s);
                    p.className = 'panel cat-' + c; // Strip 'playing' class safely
                    stat.innerText = 'Tap to Play';
                }
            }

            // Apply active UI state to the selected panel
            if (activeC >= 0 && activeS >= 0) {
                var activePanel = document.getElementById('panel-' + activeC + '-' + activeS);
                var activeStatus = document.getElementById('status-' + activeC + '-' + activeS);

                if (isPlaying) {
                    activePanel.className += ' playing';
                    activeStatus.innerText = 'Playing...';
                } else {
                    activeStatus.innerText = 'Paused';
                }
            }
        }

        // Initialize view at boot
        updateView();

    </script>
</body>
</html>
